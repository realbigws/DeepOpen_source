#include "Confo_Back.h"

//====================== Confo_Back DATA =======================//__110230__//
// Tort, Vari
double Confo_Back_DATA[512][2]=
{
	{ 0.8896, 0.6126},
	{ 0.9593, 0.3915},
	{ 0.9207, 0.6866},
	{ 1.1102, 0.8686},
	{ 1.0794, 0.0916},
	{ 0.8556, 1.2909},
	{ 0.4940, 0.9412},
	{ 0.4294, 1.3805},
	{ 0.4418, 0.7201},
	{ 0.3997, 0.7288},
	{ 0.4113, 0.8716},
	{-0.6660, 2.8672},
	{-0.4325, 2.2708},
	{-1.8420, 1.5170},
	{-0.5332, 0.8031},
	{ 0.7190, 0.0000},
	{ 1.0130, 0.4210},
	{ 0.9229, 0.5401},
	{ 1.2087, 0.2972},
	{ 0.6807, 0.9268},
	{ 0.7475, 0.4709},
	{ 0.5630, 0.9675},
	{ 0.3857, 1.3323},
	{ 0.8000, 0.0000},
	{ 1.5955, 0.8562},
	{ 1.4831, 0.8049},
	{ 2.0217, 0.4689},
	{ 1.5153, 0.7370},
	{ 1.0323, 0.3450},
	{ 1.6297, 0.5106},
	{ 0.9275, 2.7552},
	{ 1.5684, 0.1629},
	{ 1.8430, 0.2354},
	{ 1.7574, 0.2469},
	{ 1.7345, 0.1928},
	{ 1.5807, 0.2448},
	{ 1.3076, 0.0460},
	{ 1.5199, 0.2814},
	{ 1.9402, 0.3269},
	{ 1.5303, 0.0708},
	{ 1.2207, 0.2382},
	{ 1.1725, 0.3972},
	{ 1.2364, 0.1935},
	{ 1.4441, 0.2466},
	{ 1.1771, 0.1087},
	{ 1.5447, 0.2515},
	{ 1.2842, 0.5847},
	{ 1.4301, 0.1708},
	{ 0.4455, 3.2331},
	{ 0.6998, 3.0338},
	{ 0.8887, 2.4583},
	{ 0.1326, 3.1094},
	{ 1.0545, 0.6702},
	{ 0.4007, 2.9412},
	{-0.4657, 1.5274},
	{-0.1853, 2.0778},
	{-0.8551, 0.8164},
	{-0.6294, 1.0118},
	{-0.7167, 0.8709},
	{-1.1719, 0.5779},
	{-0.0733, 1.4408},
	{-1.2529, 0.4443},
	{-0.8686, 0.7149},
	{-0.9941, 0.3017},
	{ 1.4989, 0.3772},
	{ 1.4619, 0.6292},
	{ 1.5128, 0.3225},
	{ 1.6765, 0.2082},
	{ 1.1810, 0.0490},
	{ 1.5784, 0.2993},
	{ 1.8375, 0.5189},
	{ 1.3977, 0.2804},
	{ 0.9177, 0.0900},
	{ 0.9339, 0.0737},
	{ 0.9618, 0.1036},
	{ 0.9177, 0.4146},
	{ 0.8366, 0.1831},
	{ 1.0006, 0.9850},
	{ 0.7017, 0.1438},
	{ 0.7724, 0.2091},
	{ 1.6508, 0.2863},
	{ 1.7003, 0.2648},
	{ 1.7218, 0.2372},
	{ 1.4691, 0.1981},
	{ 1.1915, 0.3080},
	{ 1.4239, 0.2829},
	{ 1.8706, 0.3670},
	{ 0.9794, 0.0644},
	{ 0.9772, 2.9716},
	{ 0.4843, 3.7524},
	{ 2.1531, 1.3784},
	{ 2.2627, 1.2750},
	{ 2.0027, 0.5645},
	{ 2.2865, 0.6887},
	{-2.2710, 1.6837},
	{-9.9000,-9.9000},
	{ 0.0336, 3.0891},
	{-0.0424, 2.4427},
	{ 0.0241, 2.4642},
	{-1.5596, 1.8125},
	{ 1.0652, 0.4889},
	{-1.4892, 2.2410},
	{-0.1481, 2.8213},
	{-0.2010, 2.6898},
	{ 1.0858, 0.9199},
	{ 1.2061, 0.5034},
	{ 0.8402, 0.7481},
	{ 1.2142, 1.1419},
	{ 1.1244, 0.3766},
	{ 1.2165, 1.9297},
	{ 0.9134, 2.2752},
	{ 1.2042, 1.2779},
	{-0.3701, 1.4419},
	{ 0.2116, 1.5478},
	{ 0.1910, 1.9340},
	{-0.9045, 1.1222},
	{ 0.2843, 1.5743},
	{-1.0749, 0.7059},
	{-0.3635, 1.2182},
	{-0.9799, 0.6452},
	{ 0.1410, 0.5886},
	{ 0.2490, 0.0000},
	{-0.1096, 0.6365},
	{-0.6733, 1.0417},
	{ 0.7245, 0.3228},
	{-0.2341, 1.3419},
	{-0.1715, 0.1208},
	{-9.9000,-9.9000},
	{ 1.4536, 0.2415},
	{ 1.5723, 0.3487},
	{ 1.5070, 0.1612},
	{ 1.6036, 0.2029},
	{ 1.2175, 0.0572},
	{ 1.6147, 0.2781},
	{ 1.6113, 0.7156},
	{ 1.4626, 0.2498},
	{ 0.9035, 0.0771},
	{ 0.9162, 0.0731},
	{ 0.9757, 0.0955},
	{ 1.0732, 0.2778},
	{ 0.8107, 0.2399},
	{ 1.1586, 1.1838},
	{ 0.5775, 0.3237},
	{ 1.0323, 0.1456},
	{ 1.5523, 0.2990},
	{ 1.6524, 0.3692},
	{ 1.6883, 0.2404},
	{ 1.5521, 0.2863},
	{ 1.2138, 0.3625},
	{ 1.6143, 0.4722},
	{ 1.8756, 0.3027},
	{ 0.9784, 0.1149},
	{ 2.2663, 1.3682},
	{ 2.2015, 1.8021},
	{ 2.3100, 1.2111},
	{ 2.0167, 1.0292},
	{ 0.8360, 0.0306},
	{ 1.8714, 0.7933},
	{-2.2795, 2.1745},
	{-9.9000,-9.9000},
	{ 0.2872, 2.8884},
	{ 0.8080, 1.0424},
	{ 0.8055, 1.9528},
	{ 0.5930, 2.2845},
	{ 1.1167, 0.3214},
	{ 0.3904, 2.8115},
	{ 2.0431, 0.6607},
	{ 1.2695, 0.0589},
	{ 1.2575, 0.6527},
	{ 0.9095, 1.5648},
	{ 1.1746, 0.9435},
	{ 1.3350, 1.2211},
	{ 1.1743, 0.3452},
	{ 1.2328, 1.8685},
	{ 0.8088, 1.6100},
	{ 1.0947, 1.7461},
	{-0.6134, 1.6669},
	{-0.0649, 1.8488},
	{-0.2220, 2.0891},
	{-0.8879, 0.9157},
	{ 0.7623, 0.7861},
	{-0.7777, 1.3276},
	{-0.8099, 1.1638},
	{-1.0903, 0.2228},
	{-9.9000,-9.9000},
	{ 0.3430, 0.0000},
	{-9.9000,-9.9000},
	{-0.8852, 0.6517},
	{ 0.9500, 0.0160},
	{-0.1050, 1.3830},
	{-0.4495, 0.0359},
	{ 0.8170, 0.0000},
	{ 1.3922, 0.4413},
	{ 1.3826, 0.6113},
	{ 1.4712, 0.3541},
	{ 1.5939, 0.2699},
	{ 1.2325, 0.0679},
	{ 1.5743, 0.3764},
	{ 1.3742, 1.8513},
	{ 1.2915, 0.5834},
	{ 0.8976, 0.0971},
	{ 0.9048, 0.0785},
	{ 0.9820, 0.1059},
	{ 1.1523, 0.5421},
	{ 0.9489, 0.3694},
	{ 1.2686, 1.3989},
	{ 0.7119, 0.3060},
	{ 0.8530, 0.5062},
	{ 1.5875, 0.3483},
	{ 1.6192, 0.3286},
	{ 1.7934, 0.1934},
	{ 1.5777, 0.4038},
	{ 1.3071, 0.2558},
	{ 1.6315, 0.6581},
	{ 1.5897, 1.0689},
	{ 0.4077, 2.8717},
	{ 1.2263, 2.2492},
	{ 0.8377, 3.2247},
	{ 1.2598, 2.3276},
	{ 2.1896, 0.9761},
	{ 2.0527, 0.2627},
	{ 2.5171, 0.6836},
	{-2.1720, 2.7579},
	{-9.9000,-9.9000},
	{ 1.2493, 1.3442},
	{ 0.7224, 1.7177},
	{ 1.2215, 1.4010},
	{-1.6540, 3.0032},
	{ 1.0679, 0.4804},
	{-0.5484, 2.5671},
	{ 1.1543, 2.2844},
	{ 0.4450, 1.5971},
	{ 0.9693, 0.7421},
	{ 1.0177, 0.3076},
	{ 1.1029, 0.4411},
	{ 1.2940, 0.6443},
	{ 1.1403, 0.1874},
	{ 1.4216, 1.2246},
	{ 0.5465, 1.7605},
	{ 1.1856, 1.0626},
	{ 0.2691, 1.7050},
	{ 0.3909, 1.4996},
	{ 0.6826, 1.5512},
	{-0.7209, 1.3582},
	{ 0.8199, 0.7187},
	{-0.5894, 1.5845},
	{-0.4673, 1.3242},
	{-0.3515, 1.4553},
	{ 0.3155, 0.0030},
	{-1.3790, 0.0000},
	{ 0.4937, 0.0424},
	{-1.0895, 0.8448},
	{ 0.7540, 0.0000},
	{-1.2735, 0.0107},
	{-9.9000,-9.9000},
	{-1.3120, 0.0000},
	{ 0.2580, 1.0370},
	{ 0.7997, 0.2544},
	{ 0.1311, 1.1345},
	{-0.8418, 1.1310},
	{ 1.0552, 0.0842},
	{-0.0296, 1.6913},
	{ 0.0603, 0.5597},
	{-0.5324, 1.1106},
	{-1.0082, 1.5017},
	{-0.6280, 1.3982},
	{-0.5682, 1.5339},
	{-1.3697, 1.7480},
	{ 0.3966, 1.3940},
	{-1.4954, 1.3704},
	{-1.0102, 0.8512},
	{-1.2710, 0.0000},
	{ 0.3784, 1.1736},
	{ 0.4391, 0.8815},
	{ 0.7807, 0.9649},
	{-0.3467, 1.3466},
	{ 0.1781, 0.6054},
	{-0.5005, 1.6853},
	{-0.4953, 0.8217},
	{-9.9000,-9.9000},
	{ 1.1278, 0.5086},
	{ 1.0819, 0.5007},
	{ 1.2551, 0.7240},
	{ 1.1602, 0.9101},
	{ 0.7396, 0.2217},
	{ 1.3873, 1.0951},
	{ 0.6529, 2.1985},
	{ 0.6180, 0.0030},
	{ 1.8751, 0.1009},
	{ 1.7352, 0.1199},
	{ 1.7757, 0.1227},
	{ 1.6569, 0.0988},
	{ 1.3497, 0.0257},
	{ 1.6600, 0.1175},
	{ 2.0537, 0.1549},
	{ 1.5462, 0.0513},
	{ 1.2023, 0.1539},
	{ 1.1293, 0.1805},
	{ 1.2304, 0.1461},
	{ 1.3331, 0.1490},
	{ 1.1007, 0.0458},
	{ 1.4259, 0.1938},
	{ 1.1163, 0.3408},
	{ 1.2636, 0.2169},
	{ 1.9754, 1.2925},
	{ 1.8813, 1.6142},
	{ 1.1040, 2.5958},
	{ 1.3083, 1.2025},
	{ 1.1963, 0.1270},
	{ 1.3926, 1.1719},
	{ 0.2016, 3.7200},
	{ 1.4565, 0.4759},
	{-1.4992, 0.1558},
	{-1.4319, 0.6641},
	{-1.2124, 0.1909},
	{-1.3977, 0.0766},
	{-0.2226, 1.0199},
	{-1.3578, 0.0845},
	{-1.2057, 0.3400},
	{-1.2070, 0.0889},
	{ 0.6467, 0.9277},
	{ 0.7943, 0.4808},
	{ 0.8290, 0.8731},
	{ 0.8528, 1.4092},
	{ 1.0998, 0.0634},
	{ 0.6784, 1.5008},
	{ 0.5924, 1.0582},
	{-0.1555, 1.5223},
	{ 0.1769, 1.0324},
	{ 0.2530, 0.8302},
	{ 0.2563, 0.9063},
	{-0.7045, 2.3990},
	{ 0.3397, 0.2159},
	{-1.6192, 0.7869},
	{-0.1525, 0.9785},
	{-9.9000,-9.9000},
	{ 0.9448, 0.7263},
	{ 0.9269, 0.5575},
	{ 1.2159, 0.4713},
	{ 0.4886, 1.0632},
	{ 0.6856, 0.3271},
	{ 0.1803, 1.6843},
	{-0.0987, 1.2754},
	{-9.9000,-9.9000},
	{ 1.5030, 0.8057},
	{ 1.4671, 0.8150},
	{ 1.6061, 0.7938},
	{ 1.5757, 0.6556},
	{ 0.9757, 0.2718},
	{ 1.5333, 0.7427},
	{ 0.9820, 2.4576},
	{ 1.4828, 0.3479},
	{ 1.7638, 0.2169},
	{ 1.7588, 0.2831},
	{ 1.7895, 0.3636},
	{ 1.5369, 0.3991},
	{ 1.2744, 0.0538},
	{ 1.5705, 0.2927},
	{ 2.0414, 0.4208},
	{ 1.5144, 0.1870},
	{ 1.1777, 0.2334},
	{ 1.2647, 0.2582},
	{ 1.3293, 0.1967},
	{ 1.4186, 0.3499},
	{ 1.1606, 0.1282},
	{ 1.4727, 0.4427},
	{ 1.0471, 0.2960},
	{ 1.4176, 0.2500},
	{ 0.8939, 2.9997},
	{ 2.0228, 1.0744},
	{ 0.5149, 3.1166},
	{ 0.3267, 3.1249},
	{ 0.9447, 1.2482},
	{ 0.2626, 3.3474},
	{ 2.7165, 1.4875},
	{ 0.2851, 2.5323},
	{-1.4728, 0.3138},
	{-0.2681, 1.7186},
	{-0.9625, 0.6336},
	{-1.2907, 0.3655},
	{ 0.3064, 0.8337},
	{-1.4037, 0.4586},
	{-0.8038, 0.4581},
	{-1.0779, 0.2183},
	{ 0.9930, 1.1664},
	{ 1.0848, 0.5675},
	{ 1.1779, 0.7366},
	{ 1.0501, 1.2369},
	{ 1.1739, 0.0857},
	{ 1.0499, 1.3102},
	{ 0.9329, 1.6339},
	{ 0.8889, 1.2532},
	{ 0.8562, 0.5020},
	{ 0.8879, 0.1878},
	{ 0.9301, 0.3679},
	{ 1.0095, 1.8118},
	{ 1.1003, 0.2831},
	{ 1.8636, 1.6606},
	{ 0.4760, 1.0875},
	{ 1.5005, 0.3266},
	{ 1.3751, 0.7736},
	{ 1.4054, 0.7056},
	{ 1.6168, 0.5740},
	{ 1.1391, 2.0201},
	{ 1.1510, 0.3813},
	{ 1.3035, 1.1866},
	{ 0.7550, 2.1797},
	{-9.9000,-9.9000},
	{ 1.3299, 0.6596},
	{ 1.2168, 0.5383},
	{ 1.3981, 0.5743},
	{ 1.5850, 1.0302},
	{ 1.1716, 0.2588},
	{ 1.6003, 0.6319},
	{ 0.9431, 2.3925},
	{ 1.5234, 0.2182},
	{ 1.4805, 0.8698},
	{ 1.3346, 1.2632},
	{ 1.4447, 1.0508},
	{ 1.4694, 0.5828},
	{ 1.2818, 0.1092},
	{ 1.5191, 0.4550},
	{ 2.1429, 0.6246},
	{ 1.4646, 0.1246},
	{ 1.4426, 0.4931},
	{ 1.3998, 0.5900},
	{ 1.4630, 0.3253},
	{ 1.6319, 0.2201},
	{ 1.2602, 0.1076},
	{ 1.6667, 0.3781},
	{ 1.7939, 0.6021},
	{ 1.5459, 0.2152},
	{ 0.6150, 1.3364},
	{ 0.9229, 0.8296},
	{ 1.0779, 0.8997},
	{ 0.3145, 2.3415},
	{ 1.0694, 0.3282},
	{ 0.0426, 2.2079},
	{ 0.2359, 1.6145},
	{-0.2370, 1.6177},
	{-0.9650, 0.6036},
	{ 0.0815, 0.8663},
	{-0.5492, 0.9368},
	{-1.2319, 0.2511},
	{ 0.2900, 1.0675},
	{-1.1658, 0.4397},
	{-0.9990, 0.5901},
	{-1.1557, 0.0845},
	{ 0.9106, 0.1069},
	{ 0.9184, 0.1359},
	{ 0.9849, 0.1636},
	{ 1.1316, 0.4048},
	{ 1.1633, 0.0365},
	{ 1.1402, 0.5751},
	{ 0.9061, 0.9004},
	{ 1.1449, 0.3596},
	{ 0.1469, 0.8951},
	{ 0.3766, 0.5692},
	{ 0.2045, 0.8537},
	{-1.0953, 1.1972},
	{ 1.3230, 1.2936},
	{-0.0130, 3.8667},
	{-0.5157, 0.8354},
	{-9.9000,-9.9000},
	{ 0.9023, 0.1497},
	{ 0.9883, 0.2341},
	{ 1.0147, 0.2974},
	{ 0.4506, 0.7534},
	{ 0.4911, 0.9201},
	{-0.3037, 1.9375},
	{ 0.3587, 1.0620},
	{-9.9000,-9.9000},
	{ 1.2441, 0.4395},
	{ 1.3457, 0.2583},
	{ 1.4614, 0.3471},
	{ 1.6520, 0.5134},
	{ 1.3701, 0.2010},
	{ 1.8526, 0.2074},
	{ 1.2732, 1.7130},
	{ 1.5678, 0.0787},
	{ 2.1592, 1.0941},
	{ 0.6666, 4.1087},
	{ 0.8017, 2.8571},
	{ 2.0907, 0.6315},
	{ 1.3028, 0.1925},
	{ 1.2757, 1.8977},
	{ 2.4400, 0.5908},
	{ 1.2926, 0.7766},
	{ 1.4846, 0.2099},
	{ 1.5987, 0.4212},
	{ 1.4840, 0.2981},
	{ 1.6387, 0.1476},
	{ 1.3150, 0.0834},
	{ 1.7642, 0.1222},
	{ 1.1636, 2.3244},
	{ 1.5697, 0.1389},
	{-0.4156, 2.9076},
	{ 0.4755, 2.6880},
	{-1.1503, 1.3187},
	{-0.0412, 2.6746},
	{ 1.1037, 1.2019},
	{-0.6478, 2.0343},
	{-0.0719, 4.1747},
	{-0.6489, 1.2968},
	{-0.8722, 0.5300},
	{-0.5099, 0.7264},
	{-0.8544, 0.5328},
	{-1.2016, 0.1930},
	{ 0.0429, 0.7339},
	{-1.3182, 0.1659},
	{-0.9690, 0.4422},
	{-1.0429, 0.3024}
};

int Confo_Back_Pos_1[17]=
{  0,1,2,3,4,4,5,6,6,6, 7, 8, 9,10,11,12,10};  //-> total:13 (A->M)
// A B C D E F G H I J  K  L  M  N  O  P  Q
// 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16
int Confo_Back_Pos_2[17]=
{  0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16};  //-> total:17 (A->Q)
// A B C D E F G H I J  K  L  M  N  O  P  Q
// 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16
int Confo_Back_Pos_3[17]=
{  0,0,1,2,2,2,3,4,4,4, 4, 3, 5, 6, 7, 0, 6};  //-> total:8  (A->H)
// A B C D E F G H I J  K  L  M  N  O  P  Q
// 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16


//--------------constructor--------------------//
Confo_Back::Confo_Back(int num)
{
	Confo_Back_Maximal=num;
	Confo_Back_PRINTF=0;  //don't printf!!
	//CB_Recon
	Confo_Back_CB_Ang=110.0*M_PI/180.0;    // Ca(i)->CB bend
	Confo_Back_CB_Tor=124.0*M_PI/180.0;    // Ca(i)->CB tort
	Confo_Back_CB_Dis=1.53;                // Ca(i)->CB dist
	//Method
	Confo_Back_CN_Ang=8.76*M_PI/180.0;  // Ca(i)->N angle
	Confo_Back_CC_Ang=-20.19*M_PI/180.0;// Ca(i)->C angle
	Confo_Back_CO_Ang=-46.3*M_PI/180.0; // Ca(i)->O angle
	Confo_Back_CN_Dis=2.41;             // Ca(i)->N dist
	Confo_Back_CC_Dis=1.51;             // Ca(i)->C dist
	Confo_Back_CO_Dis=2.36;             // Ca(i)->O dist
	//create
	Confo_Back_Init(Confo_Back_Maximal);	
}
Confo_Back::~Confo_Back(void)
{
	//delete
	Confo_Back_Dele();	
}

//------------ init ------------//
void Confo_Back::Confo_Back_Init(int maxlen)
{
	//xyz_to_dbt;
	temp_mol=new XYZ[(maxlen+6)];
	temp_cle=new char[(maxlen+6)+1];
	temp_out=new XYZ[(maxlen+6)*5];
	//special_case//__110230__//
	case_mol=new XYZ[4];
	case_cle=new char[4+1];
	NewArray2D(&case_mcb,4,5);
}
void Confo_Back::Confo_Back_Dele(void)
{
	//xyz_to_dbt
	delete [] temp_mol;
	delete [] temp_cle;
	delete [] temp_out;
	//special_case//__110230__//
	delete [] case_mol;
	delete [] case_cle;
	DeleteArray2D(&case_mcb,4);
}

//===================== Universal_Method =================//
void Confo_Back::Construct_Mol(XYZ pre,XYZ cur,XYZ nxt,double bend,double tort,double dist,XYZ &out)
{
	XYZ xyz;
	double x[3],y[3];
	double z[3];
	double cb1[3],cb2[3];
	xyz=cur-pre;
	xyz.xyz2double(x);
	xyz=nxt-cur;
	xyz.xyz2double(y);
	//check
	double angle=Vector_Angle(x,y,3);
	if(fabs(angle)<1.e-3||fabs(angle-M_PI)<1.e-3)
	{
		x[0]+=0.05;
		x[2]-=0.05;
		y[0]-=0.05;
		y[2]+=0.05;
	}
	//calc
	cross(z,x,y);
	Universal_Rotation(z,bend,Confo_Back_ROT_TOT);
	Vector_Multiply(cb1,Confo_Back_ROT_TOT,x);
	Universal_Rotation(x,tort,Confo_Back_ROT_TOT);
	Vector_Multiply(cb2,Confo_Back_ROT_TOT,cb1);
	Vector_Normalize(cb2,3);
	Vector_Dot(cb2,dist,cb2,3);
	out.double2xyz(cb2);
	out+=pre;
}
void Confo_Back::Construct_Mol_II(XYZ pre,XYZ cur,XYZ nxt,double bend,double tort,double dist,XYZ &out)
{
	XYZ xyz;
	double x[3],y[3];
	double z[3];
	double cb1[3],cb2[3];
	xyz=nxt-cur;
	xyz.xyz2double(x);
	xyz=cur-pre;
	xyz.xyz2double(y);
	//check
	double angle=Vector_Angle(x,y,3);
	if(fabs(angle)<1.e-3||fabs(angle-M_PI)<1.e-3)
	{
		x[0]+=0.05;
		x[2]-=0.05;
		y[0]-=0.05;
		y[2]+=0.05;
	}
	//calc
	cross(z,x,y);
	Universal_Rotation(z,bend,Confo_Back_ROT_TOT);
	Vector_Multiply(cb1,Confo_Back_ROT_TOT,x);
	Universal_Rotation(x,tort,Confo_Back_ROT_TOT);
	Vector_Multiply(cb2,Confo_Back_ROT_TOT,cb1);
	Vector_Normalize(cb2,3);
	Vector_Dot(cb2,dist,cb2,3);
	out.double2xyz(cb2);
	out+=nxt;
}
void Confo_Back::Construct_CB(XYZ N,XYZ Ca,XYZ C,double bend,double tort,double dist,XYZ &Cb)
{
	XYZ xyz;
	double x[3],y[3];
	double z[3];
	double cb1[3],cb2[3];
	xyz=C-Ca;
	xyz.xyz2double(x);
	xyz=Ca-N;
	xyz.xyz2double(y);
	cross(z,x,y);
	Universal_Rotation(z,-1.0*bend,Confo_Back_ROT_TOT);
	Vector_Multiply(cb1,Confo_Back_ROT_TOT,x);
	Universal_Rotation(x,-1.0*tort,Confo_Back_ROT_TOT);
	Vector_Multiply(cb2,Confo_Back_ROT_TOT,cb1);
	Vector_Normalize(cb2,3);
	Vector_Dot(cb2,dist,cb2,3);
	Cb.double2xyz(cb2);
	Cb+=Ca;
}

//===================== Method ======================//
//-> special dealing -> moln==2
int Confo_Back::Recon_Back_2pre(XYZ *mol,char *cle,int moln,XYZ **output,XYZ pre)
{
	if(moln!=2)return -1;
	XYZ real;
	double dist;
	real=pre-mol[0];
	dist=pre.distance(mol[0]);
	real=real/dist;
	real=real*3.8;
	real=mol[0]+real;
	//construct
	case_mol[0]=real;
	case_mol[1]=mol[0];
	case_mol[2]=mol[1];
	case_cle[0]='Q';
	if(cle[0]!='R')case_cle[1]=cle[0];
	else case_cle[1]='Q';
	if(cle[1]!='R')case_cle[2]=cle[1];
	else case_cle[2]='Q';
	//build
	int retv;
	retv=Recon_Back(case_mol,case_cle,3,case_mcb);
	if(retv!=1)return retv;
	//final
	int i,j;
	for(i=0;i<2;i++)for(j=0;j<5;j++)output[i][j]=case_mcb[i+1][j];
	//return
	return 1;
}
int Confo_Back::Recon_Back_2nxt(XYZ *mol,char *cle,int moln,XYZ **output,XYZ nxt)
{
	if(moln!=2)return -1;
	XYZ real;
	double dist;
	real=nxt-mol[1];
	dist=nxt.distance(mol[1]);
	real=real/dist;
	real=real*3.8;
	real=mol[1]+real;
	//construct
	case_mol[0]=mol[0];
	case_mol[1]=mol[1];
	case_mol[2]=real;
	if(cle[0]!='R')case_cle[0]=cle[0];
	else case_cle[0]='Q';
	if(cle[1]!='R')case_cle[1]=cle[1];
	else case_cle[1]='Q';
	case_cle[2]='Q';
	//build
	int retv;
	retv=Recon_Back(case_mol,case_cle,3,case_mcb);
	if(retv!=1)return retv;
	//final
	int i,j;
	for(i=0;i<2;i++)for(j=0;j<5;j++)output[i][j]=case_mcb[i][j];
	//return
	return 1;
}
int Confo_Back::Recon_Back_Two(XYZ *mol,char *cle,int moln,XYZ **output,XYZ pre,XYZ nxt)
{
	if(moln!=2)return -1;
	XYZ real;
	double dist;
	//pre
	real=pre-mol[0];
	dist=pre.distance(mol[0]);
	real=real/dist;
	real=real*3.8;
	case_mol[0]=mol[0]+real;
	//nxt
	real=nxt-mol[1];
	dist=nxt.distance(mol[1]);
	real=real/dist;
	real=real*3.8;
	case_mol[3]=mol[1]+real;
	//construct
	case_mol[1]=mol[0];
	case_mol[2]=mol[1];
	case_cle[0]='Q';
	if(cle[0]!='R')case_cle[1]=cle[0];
	else case_cle[1]='Q';
	if(cle[1]!='R')case_cle[2]=cle[1];
	else case_cle[2]='Q';
	case_cle[3]='Q';
	//build
	int retv;
	retv=Recon_Back(case_mol,case_cle,4,case_mcb);
	if(retv!=1)return retv;
	//final
	int i,j;
	for(i=0;i<2;i++)for(j=0;j<5;j++)output[i][j]=case_mcb[i+1][j];
	//return
	return 1;
}
//-> special dealing -> moln==1
int Confo_Back::Recon_Back_1pre(XYZ *mol,char *cle,int moln,XYZ **output,XYZ pre)
{
	if(moln!=1)return -1;
	XYZ real;
	double dist;
	real=pre-mol[0];
	dist=pre.distance(mol[0]);
	real=real/dist;
	real=real*3.8;
	//construct
	case_mol[0]=mol[0]+real;
	case_mol[1]=mol[0];
	case_mol[2]=mol[0]-real;
	case_cle[0]='Q';
	if(cle[0]!='R')case_cle[1]=cle[0];
	else case_cle[1]='Q';
	case_cle[2]='Q';
	//build
	int retv;
	retv=Recon_Back(case_mol,case_cle,3,case_mcb);
	if(retv!=1)return retv;
	//final
	int j;
	for(j=0;j<5;j++)output[0][j]=case_mcb[1][j];
	//return
	return 1;
}
int Confo_Back::Recon_Back_1nxt(XYZ *mol,char *cle,int moln,XYZ **output,XYZ nxt)
{
	if(moln!=1)return -1;
	XYZ real;
	double dist;
	real=nxt-mol[0];
	dist=nxt.distance(mol[0]);
	real=real/dist;
	real=real*3.8;
	//construct
	case_mol[0]=mol[0]-real;
	case_mol[1]=mol[0];
	case_mol[2]=mol[0]+real;
	case_cle[0]='Q';
	if(cle[0]!='R')case_cle[1]=cle[0];
	else case_cle[1]='Q';
	case_cle[2]='Q';
	//build
	int retv;
	retv=Recon_Back(case_mol,case_cle,3,case_mcb);
	if(retv!=1)return retv;
	//final
	int j;
	for(j=0;j<5;j++)output[0][j]=case_mcb[1][j];
	//return
	return 1;
}
int Confo_Back::Recon_Back_One(XYZ *mol,char *cle,int moln,XYZ **output,XYZ pre,XYZ nxt)
{
	if(moln!=1)return -1;
	XYZ real;
	double dist;
	//pre
	real=pre-mol[0];
	dist=pre.distance(mol[0]);
	real=real/dist;
	real=real*3.8;
	case_mol[0]=mol[0]+real;
	//nxt
	real=nxt-mol[0];
	dist=nxt.distance(mol[0]);
	real=real/dist;
	real=real*3.8;
	case_mol[2]=mol[0]+real;
	//construct
	case_mol[1]=mol[0];
	case_cle[0]='Q';
	if(cle[0]!='R')case_cle[1]=cle[0];
	else case_cle[1]='Q';
	case_cle[2]='Q';
	//build
	int retv;
	retv=Recon_Back(case_mol,case_cle,3,case_mcb);
	if(retv!=1)return retv;
	//final
	int j;
	for(j=0;j<5;j++)output[0][j]=case_mcb[1][j];
	//return
	return 1;
}

//======================= [main] ======================//
//use 512 bins to separate local continous C-Alpha atoms (CLE) //-> must greater than 3
int Confo_Back::Recon_Back(XYZ *mol,char *cle,int moln,XYZ **output)  //input CA -> output Backbone (Method)
{
	int i,j;
	char a,b,c;
	int pos;
	double tort;
	double vari;
	XYZ N,C,O,CB;

	//pseudo_mol//__101130__//
	if(moln<3)return -1;
	int temp_moln;
	for(i=0;i<3;i++)temp_mol[i]=0.0;
	EqualArray(temp_mol+3,mol,moln);
	EqualArray(temp_cle+3,cle,moln);
	for(i=2;i>=0;i--)Construct_Mol_II(temp_mol[i+3],temp_mol[i+2],temp_mol[i+1],-0.863,0.372,3.8,temp_mol[i]); //using CLE 'Q'
	for(i=2;i>=0;i--)temp_cle[i]='Q';
	for(i=0;i<3;i++)Construct_Mol_II(temp_mol[moln+i],temp_mol[moln+1+i],temp_mol[moln+2+i],-0.863,0.372,3.8,temp_mol[moln+3+i]); //using CLE 'Q'
	for(i=0;i<3;i++)temp_cle[moln-3+i]='Q';
	temp_moln=moln+6;
	btb_ori(0,0,0,temp_moln,temp_mol,temp_cle);
	for(i=0;i<temp_moln;i++)if(temp_cle[i]=='R')temp_cle[i]='Q';
	//pseudo_mol//__101130__//over

	//init
	int digit[3];
	int input[3];
	digit[0]=8;
	digit[1]=8;
	digit[2]=8;
	//init(add 2) [using QQQ]	
	for(i=0;i<2;i++)
	{
		input[0]=Confo_Back_Pos_3['Q'-'A'];
		input[1]=Confo_Back_Pos_3['Q'-'A'];
		input[2]=Confo_Back_Pos_3['Q'-'A'];
		//get_tort
		MI_Uni_For_Map(pos,input,digit,3);
		tort=Confo_Back_DATA[pos][0];  //Tort
		vari=Confo_Back_DATA[pos][1];  //Vari
		//calc
		Construct_Mol(temp_mol[i],temp_mol[i+1],temp_mol[i+2],-1.0*Confo_Back_CN_Ang,tort,Confo_Back_CN_Dis,N);
		Construct_Mol(temp_mol[i],temp_mol[i+1],temp_mol[i+2],-1.0*Confo_Back_CC_Ang,tort,Confo_Back_CC_Dis,C);
		Construct_Mol(temp_mol[i],temp_mol[i+1],temp_mol[i+2],-1.0*Confo_Back_CO_Ang,tort,Confo_Back_CO_Dis,O);
		//assign
		//first_res
		if(i==0)
		{
			N=N-temp_mol[1]+temp_mol[0];
			temp_out[0*5+0]=N;              //atom N(i)
		}
		temp_out[i*5+1]=temp_mol[i];        //atom CA(i)
		temp_out[i*5+2]=C;                  //atom C (i)
		temp_out[i*5+3]=O;                  //atom O (i)
		Construct_CB(temp_out[i*5+0],temp_out[i*5+1],temp_out[i*5+2],Confo_Back_CB_Ang,Confo_Back_CB_Tor,Confo_Back_CB_Dis,CB);
		temp_out[i*5+4]=CB;                 //atom CB(i)
		temp_out[(i+1)*5+0]=N;              //atom N (i+1)
	}
	//midd
	for(i=2;i<temp_moln-3;i++)
	{
		//get_cle
		a=temp_cle[i];
		b=temp_cle[i+1];
		c=temp_cle[i+2];
		input[0]=Confo_Back_Pos_3[a-'A'];
		input[1]=Confo_Back_Pos_3[b-'A'];
		input[2]=Confo_Back_Pos_3[c-'A'];
		//get_tort
		MI_Uni_For_Map(pos,input,digit,3);
		tort=Confo_Back_DATA[pos][0];  //Tort
		vari=Confo_Back_DATA[pos][1];  //Vari
		//calc
		Construct_Mol(temp_mol[i],temp_mol[i+1],temp_mol[i+2],-1.0*Confo_Back_CN_Ang,tort,Confo_Back_CN_Dis,N);
		Construct_Mol(temp_mol[i],temp_mol[i+1],temp_mol[i+2],-1.0*Confo_Back_CC_Ang,tort,Confo_Back_CC_Dis,C);
		Construct_Mol(temp_mol[i],temp_mol[i+1],temp_mol[i+2],-1.0*Confo_Back_CO_Ang,tort,Confo_Back_CO_Dis,O);
		//assign
		temp_out[i*5+1]=temp_mol[i];        //atom CA(i)
		temp_out[i*5+2]=C;                  //atom C (i)
		temp_out[i*5+3]=O;                  //atom O (i)
		Construct_CB(temp_out[i*5+0],temp_out[i*5+1],temp_out[i*5+2],Confo_Back_CB_Ang,Confo_Back_CB_Tor,Confo_Back_CB_Dis,CB);
		temp_out[i*5+4]=CB;                 //atom CB(i)
		temp_out[(i+1)*5+0]=N;              //atom N (i+1)
	}

	//pseudo_mol//__101130__//
	for(i=0;i<moln;i++)for(j=0;j<5;j++)output[i][j]=temp_out[(i+3)*5+j];
	//pseudo_mol//__101130__//over
	return 1;
}

//================ main function for BROLEN ===============//
//[Method]
int Confo_Back::Recon_Back_Main(XYZ *in,char *cle,int moln,XYZ **out)
{
	int i;
	int start,len;
	int BROKEN;
	int broke;
	int first;

	//init_check
	if(moln==1)
	{
		printf("Recon_Back FAILED!!! Only ONE residue!!\n");
		exit(-1);
	}
	//init
	start=0;
	BROKEN=0;
	//new_version
	len=0;
	broke=0;
	first=1;
	for(i=0;i<moln;i++)
	{
		if(cle[i]=='R')
		{
			if(first==0)
			{
				//process
				len++;
				Recon_Back(in+start,cle+start,len,out+start);
				//printf
				if(i!=moln-1)
				{
					BROKEN++;
					if(Confo_Back_PRINTF==1)printf("BROKEN_FOUND[%d]!!\r",i);
				}
			}
			else
			{
				broke++;
			}
			first=1;
		}
		else
		{
			if(first==1)
			{
				start=i-2;
				len=3;
				if(broke>2)
				{
					BROKEN++;
					if(Confo_Back_PRINTF==1)printf("BROKEN_MULTI[%d]!!\r",i);
					//at current version, we cannot deal with len<3!!! //(now we can!!)//__110230__//
					if(broke-2<3)
					{
						if(broke-2==1) //one case
						{
							Recon_Back_One(in+i-broke,cle+i-broke,broke-2,out+i-broke,in[i-broke-1],in[i-2]);
						}
						else           //two case
						{
							Recon_Back_Two(in+i-broke,cle+i-broke,broke-2,out+i-broke,in[i-broke-1],in[i-2]);
						}
					}
					else Recon_Back(in+i-broke,cle+i-broke,broke-2,out+i-broke);
				}
				broke=0;
			}
			else
			{
				len++;
			}
			first=0;
		}
	}
	//final
	if(broke!=0)
	{
		BROKEN++;
		if(Confo_Back_PRINTF==1)printf("BROKEN_TERMI[%d]!!\r",i);
		//at current version, we cannot deal with len<3!!!  //(now we can!!)//__110230__//
		if(broke<3)
		{
			if(broke==1) //one case
			{
				Recon_Back_1pre(in+moln-broke,cle+moln-broke,broke,out+moln-broke,in[moln-broke-1]);
			}
			else         //two case
			{
				Recon_Back_2pre(in+moln-broke,cle+moln-broke,broke,out+moln-broke,in[moln-broke-1]);
			}
		}
		else Recon_Back(in+moln-broke,cle+moln-broke,broke,out+moln-broke);
	}
	//final
	return BROKEN;
}
